<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather App + Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Th√™m th∆∞ vi·ªán ƒë·ªÉ render Markdown ƒë∆°n gi·∫£n n·∫øu c·∫ßn, ·ªü ƒë√¢y d√πng text thu·∫ßn cho nh·∫π -->
    <style>
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
      .animate-spin-slow { animation: spin 12s linear infinite; }
      .animate-bounce-slow { animation: bounce 3s infinite; }
      .bg-animate {
        background-size: 400% 400%;
        animation: gradientShift 18s ease infinite;
      }
      .card-float { animation: float 6s ease-in-out infinite; }
      
      /* Glassmorphism improvements */
      .glass-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      }
      
      .glass-card-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .glass-card-hover:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateY(-2px);
        box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
      }
      
      /* Gradient text */
      .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      /* Glow effects */
      .glow-blue {
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.5), 0 0 40px rgba(59, 130, 246, 0.3);
      }
      .glow-purple {
        box-shadow: 0 0 20px rgba(168, 85, 247, 0.5), 0 0 40px rgba(168, 85, 247, 0.3);
      }
      
      /* Scrollbar cho khung chat */
      .chat-scroll::-webkit-scrollbar { width: 6px; }
      .chat-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
      .chat-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
      .chat-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

      .typing-dot {
        animation: typing 1.4s infinite ease-in-out both;
      }
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }

      @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
      }

      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
      }
      @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
      }
      .shimmer {
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        background-size: 1000px 100%;
        animation: shimmer 3s infinite;
      }

      /* Sky effects */
      .rain-overlay {
        background-image: linear-gradient(rgba(255,255,255,0.18) 30%, transparent 0);
        background-size: 2px 24px;
        animation: rainMove 0.6s linear infinite;
        opacity: 0.35;
      }
      @keyframes rainMove { to { background-position: 0 24px; } }

      .snow-overlay {
        background-image:
          radial-gradient(2px 2px at 20% 20%, rgba(255,255,255,0.8) 50%, transparent 55%),
          radial-gradient(2px 2px at 40% 40%, rgba(255,255,255,0.8) 50%, transparent 55%),
          radial-gradient(2px 2px at 60% 60%, rgba(255,255,255,0.8) 50%, transparent 55%),
          radial-gradient(2px 2px at 80% 30%, rgba(255,255,255,0.8) 50%, transparent 55%),
          radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,0.8) 50%, transparent 55%);
        background-size: 200px 200px;
        animation: snowMove 8s linear infinite;
        opacity: 0.6;
      }
      @keyframes snowMove { to { background-position: 0 200px, 0 200px, 0 200px, 0 200px, 0 200px; } }

      .storm-overlay {
        background: radial-gradient(ellipse at center, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0) 60%);
        animation: flash 4s infinite;
        mix-blend-mode: screen;
      }
      @keyframes flash {
        0%, 80%, 100% { opacity: 0; }
        82% { opacity: 0.45; }
        84% { opacity: 0; }
        88% { opacity: 0.35; }
      }

      .stars-overlay {
        background-image:
          radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.8) 50%, transparent 55%),
          radial-gradient(1px 1px at 30% 80%, rgba(255,255,255,0.6) 50%, transparent 55%),
          radial-gradient(1.5px 1.5px at 70% 30%, rgba(255,255,255,0.9) 50%, transparent 55%),
          radial-gradient(1px 1px at 85% 60%, rgba(255,255,255,0.7) 50%, transparent 55%),
          radial-gradient(1px 1px at 55% 10%, rgba(255,255,255,0.9) 50%, transparent 55%);
        background-size: 220px 220px;
        animation: twinkle 6s ease-in-out infinite;
        opacity: 0.7;
      }
      @keyframes twinkle {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 0.95; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useCallback, useEffect, useMemo, useRef } = React;

      // --- C·∫§U H√åNH GEMINI ---
      const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
      
      // H√†m g·ªçi API Gemini v·ªõi backoff
      const generateContent = async (apiKey, prompt, systemInstruction) => {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
        
        const payload = {
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemInstruction }] }
        };

        const delays = [1000, 2000, 4000];
        
        for (let i = 0; i <= delays.length; i++) {
          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!response.ok) {
              if (response.status === 429 && i < delays.length) {
                await new Promise(r => setTimeout(r, delays[i]));
                continue;
              }
              throw new Error(`Gemini Error: ${response.statusText}`);
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Kh√¥ng c√≥ ph·∫£n h·ªìi.";
          } catch (error) {
            if (i === delays.length) throw error;
          }
        }
      };

      // --- ICONS & MOCK DATA ---
      const Icons = {
        search: "üîç", mapPin: "üìç", wind: "üí®", drop: "üíß", thermometer: "üå°Ô∏è",
        nav: "üß≠", alert: "‚ö†Ô∏è", sun: "‚òÄÔ∏è", cloud: "‚òÅÔ∏è", rain: "üåßÔ∏è",
        lightning: "üå©Ô∏è", moon: "üåô", settings: "‚öôÔ∏è", close: "‚úñÔ∏è",
        robot: "ü§ñ", send: "üì§", user: "üë§", spark: "‚ú®"
      };

      const MOCK_DATA = {
        location: { name: "Ho Chi Minh City", country: "Vietnam", localtime_epoch: 1709553600, lat: 10.7769, lon: 106.7009 },
        current: { temp_c: 32, condition: { text: "N·∫Øng nh·∫π", code: 1000 }, wind_kph: 15, humidity: 65, feelslike_c: 36, pressure_mb: 1012, vis_km: 10, is_day: 1, uv: 9 },
        alerts: { alert: [] },
        forecast: {
          forecastday: Array.from({ length: 7 }, (_, i) => {
            const base = 1709553600 + i * 86400;
            return {
              date_epoch: base,
              date: new Date(base * 1000).toISOString().split('T')[0],
              day: { maxtemp_c: 34 - i, mintemp_c: 26 - i * 0.5, daily_chance_of_rain: 20 + i * 5, condition: { text: i % 2 === 0 ? "N·∫Øng nh·∫π" : "C√≥ m√¢y", code: i % 2 === 0 ? 1000 : 1003 } },
              astro: { sunrise: "06:00 AM", sunset: "06:00 PM" }
            };
          })
        }
      };

      const CITY_SUGGESTIONS = ["H√† N·ªôi","Ho Chi Minh","ƒê√† N·∫µng","H·∫£i Ph√≤ng","C·∫ßn Th∆°","Nha Trang","Hu·∫ø","V≈©ng T√†u","ƒê√† L·∫°t","Ph√∫ Qu·ªëc","Singapore","Bangkok","Seoul","Tokyo","Paris","London","New York","Sydney"];

      // --- COMPONENT CHAT AI ---
      const AIChatModal = ({ show, onClose, weatherData, geminiKey }) => {
        const [messages, setMessages] = useState([
          { role: 'model', text: 'Xin ch√†o! T√¥i l√† tr·ª£ l√Ω th·ªùi ti·∫øt AI. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n d·ª±a tr√™n t√¨nh h√¨nh th·ªùi ti·∫øt hi·ªán t·∫°i?' }
        ]);
        const [input, setInput] = useState("");
        const [loading, setLoading] = useState(false);
        const chatEndRef = useRef(null);

        useEffect(() => {
          chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages, show]);

        const handleSend = async () => {
          if (!input.trim()) return;
          if (!geminiKey) {
            setMessages(prev => [...prev, { role: 'user', text: input }, { role: 'model', text: 'Vui l√≤ng nh·∫≠p Gemini API Key trong ph·∫ßn C√†i ƒë·∫∑t ƒë·ªÉ tr√≤ chuy·ªán v·ªõi t√¥i.' }]);
            setInput("");
            return;
          }

          const userMsg = input;
          setInput("");
          setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
          setLoading(true);

          try {
            const context = `
              D·ªØ li·ªáu th·ªùi ti·∫øt hi·ªán t·∫°i:
              - ƒê·ªãa ƒëi·ªÉm: ${weatherData.location.name}, ${weatherData.location.country}
              - Nhi·ªát ƒë·ªô: ${weatherData.current.temp_c}¬∞C (C·∫£m gi√°c nh∆∞ ${weatherData.current.feelslike_c}¬∞C)
              - T√¨nh tr·∫°ng: ${weatherData.current.condition.text}
              - Gi√≥: ${weatherData.current.wind_kph} km/h
              - ƒê·ªô ·∫©m: ${weatherData.current.humidity}%
              - UV: ${weatherData.current.uv}
              - C·∫£nh b√°o: ${weatherData.alerts?.alert?.length > 0 ? JSON.stringify(weatherData.alerts.alert) : "Kh√¥ng c√≥"}
            `;
            
            const systemPrompt = "B·∫°n l√† m·ªôt chuy√™n gia th·ªùi ti·∫øt vui t√≠nh v√† h·ªØu √≠ch. H√£y tr·∫£ l·ªùi ng·∫Øn g·ªçn, t·∫≠p trung v√†o l·ªùi khuy√™n th·ª±c t·∫ø (trang ph·ª•c, ho·∫°t ƒë·ªông, s·ª©c kh·ªèe) d·ª±a tr√™n d·ªØ li·ªáu th·ªùi ti·∫øt ƒë∆∞·ª£c cung c·∫•p. Ng√¥n ng·ªØ: Ti·∫øng Vi·ªát.";
            const fullPrompt = `${context}\n\nNg∆∞·ªùi d√πng h·ªèi: ${userMsg}`;

            const reply = await generateContent(geminiKey, fullPrompt, systemPrompt);
            setMessages(prev => [...prev, { role: 'model', text: reply }]);
          } catch (err) {
            setMessages(prev => [...prev, { role: 'model', text: "Xin l·ªói, t√¥i ƒëang g·∫∑p s·ª± c·ªë k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i sau." }]);
          } finally {
            setLoading(false);
          }
        };

        const suggestions = ["H√¥m nay n√™n m·∫∑c g√¨?", "C√≥ n√™n ƒëi ch·∫°y b·ªô kh√¥ng?", "Th·ªùi ti·∫øt n√†y ƒÉn g√¨ ngon?", "D·ª± b√°o ng√†y mai th·∫ø n√†o?"];

        if (!show) return null;

        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
            <div className="bg-slate-900/95 w-full max-w-lg h-[600px] rounded-3xl border border-white/20 shadow-2xl flex flex-col overflow-hidden relative">
              {/* Header */}
              <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                <div className="flex items-center gap-2">
                  <span className="text-2xl">{Icons.robot}</span>
                  <div>
                    <h3 className="font-bold text-white">Gemini Weather AI</h3>
                    <p className="text-xs text-blue-300">ƒê∆∞·ª£c h·ªó tr·ª£ b·ªüi Google Gemini</p>
                  </div>
                </div>
                <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full text-white transition">{Icons.close}</button>
              </div>

              {/* Chat Body */}
              <div className="flex-1 overflow-y-auto p-4 space-y-4 chat-scroll">
                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[80%] p-3 rounded-2xl text-sm leading-relaxed ${
                      msg.role === 'user' 
                        ? 'bg-blue-600 text-white rounded-br-none' 
                        : 'bg-white/10 text-white/90 rounded-bl-none border border-white/5'
                    }`}>
                      {msg.text.split('\n').map((line, i) => <div key={i}>{line}</div>)}
                    </div>
                  </div>
                ))}
                {loading && (
                  <div className="flex justify-start">
                    <div className="bg-white/10 p-4 rounded-2xl rounded-bl-none flex gap-1">
                      <div className="w-2 h-2 bg-white/50 rounded-full typing-dot"></div>
                      <div className="w-2 h-2 bg-white/50 rounded-full typing-dot"></div>
                      <div className="w-2 h-2 bg-white/50 rounded-full typing-dot"></div>
                    </div>
                  </div>
                )}
                <div ref={chatEndRef} />
              </div>

              {/* Suggestions */}
              {!loading && messages.length < 3 && (
                <div className="px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar">
                  {suggestions.map((s, i) => (
                    <button key={i} onClick={() => setInput(s)} className="whitespace-nowrap px-3 py-1 bg-white/5 hover:bg-white/10 border border-white/10 rounded-full text-xs text-blue-200 transition">
                      {s}
                    </button>
                  ))}
                </div>
              )}

              {/* Input Area */}
              <div className="p-4 bg-white/5 border-t border-white/10">
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyDown={(e) => e.key === 'Enter' && handleSend()}
                    placeholder="H·ªèi Gemini v·ªÅ th·ªùi ti·∫øt..."
                    className="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition"
                  />
                  <button 
                    onClick={handleSend}
                    disabled={loading || !input.trim()}
                    className="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white p-3 rounded-xl transition"
                  >
                    {Icons.send}
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // --- MAIN APP ---
      function WeatherApp() {
        const [weather, setWeather] = useState(MOCK_DATA);
        const [query, setQuery] = useState("");
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const [weatherApiKey, setWeatherApiKey] = useState("94bac91a42cc4a76be275058251512");
        const [geminiApiKey, setGeminiApiKey] = useState("AIzaSyCZVhpLuxW6rhgo3yyHqCOMoOTJfhqT49E"); // State cho Gemini Key
        const [showSettings, setShowSettings] = useState(false);
        const [showSuggest, setShowSuggest] = useState(false);
        const [showChat, setShowChat] = useState(false); // State hi·ªÉn th·ªã Chat
        const [selectedDayIdx, setSelectedDayIdx] = useState(0);

        useEffect(() => { setSelectedDayIdx(0); }, [weather]);

        const fetchWeather = useCallback(async (searchQuery) => {
          if (!weatherApiKey) {
            setError("Vui l√≤ng nh·∫≠p WeatherAPI Key trong ph·∫ßn c√†i ƒë·∫∑t.");
            return;
          }
          setLoading(true);
          setError("");
          try {
            const response = await fetch(`https://api.weatherapi.com/v1/forecast.json?key=${weatherApiKey}&q=${searchQuery}&days=7&alerts=yes&lang=vi`);
            if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm ho·∫∑c l·ªói API Key.");
            const data = await response.json();
            setWeather(data);
          } catch (err) {
            setError(err.message || "ƒê√£ c√≥ l·ªói x·∫£y ra.");
          } finally {
            setLoading(false);
          }
        }, [weatherApiKey]);

        const handleSearch = (e) => {
          e.preventDefault();
          if (query.trim()) {
            setShowSuggest(false);
            fetchWeather(query);
          }
        };

        const handleLocation = () => {
          if (!navigator.geolocation) { setError("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã."); return; }
          setLoading(true);
          navigator.geolocation.getCurrentPosition(
            (pos) => fetchWeather(`${pos.coords.latitude},${pos.coords.longitude}`),
            () => { setError("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠."); setLoading(false); }
          );
        };

        const getBackgroundClass = () => {
            if (!weather) return "bg-gradient-to-br from-blue-400 to-blue-600";
            const isDay = weather.current.is_day === 1;
            const code = weather.current.condition.code;
            if (code === 1000) {
              return isDay
                ? "bg-gradient-to-br from-blue-400 via-blue-300 to-yellow-200"
                : "bg-gradient-to-br from-slate-900 via-purple-900 to-slate-800";
            } else if ([1003, 1006, 1009].includes(code)) {
              return isDay
                ? "bg-gradient-to-br from-slate-300 via-blue-200 to-slate-400"
                : "bg-gradient-to-br from-gray-800 via-gray-700 to-gray-900";
            } else if ([1063, 1183, 1186, 1189, 1192, 1195, 1240].includes(code)) {
              return "bg-gradient-to-br from-slate-700 via-blue-900 to-slate-800 rainy-theme";
            } else if ([1273, 1276, 1087].includes(code)) {
              return "bg-gradient-to-br from-indigo-950 via-slate-900 to-black storm-theme";
            }
            return "bg-gradient-to-br from-blue-500 to-cyan-400";
        };

        const getWeatherIcon = () => {
            if (!weather) return Icons.sun;
            const code = weather.current.condition.code;
            const isDay = weather.current.is_day === 1;
            if (code === 1000) return isDay ? Icons.sun : Icons.moon;
            if ([1003, 1006].includes(code)) return Icons.cloud;
            if (code >= 1180 && code <= 1201) return Icons.rain;
            if (code >= 1273) return Icons.lightning;
            return Icons.cloud;
        };

        const getSkyEffect = () => {
          if (!weather) return null;
          const code = weather.current.condition.code;
          const isDay = weather.current.is_day === 1;
          const isRain = (code >= 1180 && code <= 1246);
          const isSnow = (code === 1066 || code === 1114 || code === 1117 || (code >= 1210 && code <= 1237) || (code >= 1255 && code <= 1264));
          const isStorm = (code >= 1273 || code === 1087);
          if (isStorm) return "storm";
          if (isSnow) return "snow";
          if (isRain) return "rain";
          if (code === 1000 && !isDay) return "stars";
          return null;
        };

        const todayAstro = useMemo(() => weather?.forecast?.forecastday?.[0]?.astro || { sunrise: "--", sunset: "--" }, [weather]);
        const todayDetail = useMemo(() => weather?.forecast?.forecastday?.[0]?.day || null, [weather]);

        const mapUrl = useMemo(() => {
          const lat = weather?.location?.lat ?? 21.0278;
          const lon = weather?.location?.lon ?? 105.8342;
          return `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&detailLat=${lat}&detailLon=${lon}&width=100%&height=450&zoom=6&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=true&calendar=now&pressure=true&type=map&location=coordinates&detail=true&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1`;
        }, [weather]);

        const sunProgress = useMemo(() => {
           if (!todayAstro.sunrise || !todayAstro.sunset) return 0;
           // Logic t√≠nh to√°n ƒë∆°n gi·∫£n
           return 50; 
        }, [todayAstro]);

        return (
          <div className={"relative min-h-screen w-full transition-all duration-1000 ease-in-out p-4 md:p-8 flex items-center justify-center overflow-hidden " + getBackgroundClass()}>
            <div className="absolute inset-0 bg-gradient-to-br from-white/5 via-transparent to-white/5 blur-3xl bg-animate pointer-events-none"></div>
            {(() => {
              const effect = getSkyEffect();
              if (effect === "rain") return <div className="absolute inset-0 rain-overlay pointer-events-none"></div>;
              if (effect === "snow") return <div className="absolute inset-0 snow-overlay pointer-events-none"></div>;
              if (effect === "storm") return <div className="absolute inset-0 storm-overlay pointer-events-none"></div>;
              if (effect === "stars") return <div className="absolute inset-0 stars-overlay pointer-events-none"></div>;
              return null;
            })()}
            
            <div className="w-full max-w-5xl glass-card rounded-3xl overflow-hidden text-white relative card-float">
                
                {/* Header Control */}
                <div className="p-6 flex flex-col md:flex-row gap-4 items-center justify-between bg-gradient-to-r from-black/20 via-black/10 to-black/20 backdrop-blur-md border-b border-white/10 relative z-20">
                  <form onSubmit={handleSearch} className="relative w-full md:w-96 group">
                    <input
                      type="text" placeholder="T√¨m th√†nh ph·ªë..." value={query}
                      onFocus={() => setShowSuggest(true)}
                      onBlur={() => setTimeout(() => setShowSuggest(false), 150)}
                      onChange={(e) => { setQuery(e.target.value); setShowSuggest(true); }}
                      className="w-full pl-12 pr-4 py-3.5 bg-white/15 backdrop-blur-sm border border-white/20 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400/50 focus:bg-white/25 transition-all duration-300 placeholder-white/60 text-white shadow-lg"
                    />
                    <span className="absolute left-4 top-4 text-white/70 text-lg">{Icons.search}</span>
                    {showSuggest && (
                      <div className="absolute z-30 top-[3.5rem] left-0 right-0 glass-card rounded-2xl shadow-2xl max-h-60 overflow-auto border border-white/20">
                        {CITY_SUGGESTIONS.filter((c) => c.toLowerCase().includes(query.toLowerCase())).slice(0, 8).map((city) => (
                          <button key={city} type="button" className="w-full text-left px-4 py-3 hover:bg-white/10 text-white text-sm transition-all duration-200 first:rounded-t-2xl last:rounded-b-2xl" onClick={() => { setQuery(city); setShowSuggest(false); fetchWeather(city); }}>{city}</button>
                        ))}
                      </div>
                    )}
                  </form>
                  
                  <div className="flex gap-3">
                     <button onClick={() => setShowChat(true)} className="p-3 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 hover:from-blue-400 hover:via-purple-400 hover:to-pink-400 rounded-full transition-all duration-300 shadow-lg shadow-purple-500/40 flex items-center gap-2 px-5 group glow-purple hover:scale-105" title="H·ªèi AI Gemini">
                      <span className="text-xl group-hover:rotate-12 transition-transform duration-300">{Icons.spark}</span> 
                      <span className="font-semibold text-sm hidden sm:inline">AI Chat</span>
                    </button>
                    <button onClick={handleLocation} className="p-3 glass-card-hover rounded-full transition-all duration-300 hover:scale-110 shadow-md" title="V·ªã tr√≠ hi·ªán t·∫°i">{Icons.nav}</button>
                    <button onClick={() => setShowSettings(true)} className="p-3 glass-card-hover rounded-full transition-all duration-300 hover:scale-110 shadow-md" title="C√†i ƒë·∫∑t">{Icons.settings}</button>
                  </div>
                </div>

                {/* Error & Loading */}
                {error && <div className="bg-red-500/80 text-white p-3 text-center animate-pulse">{error}</div>}
                
                {loading ? (
                  <div className="h-96 flex flex-col items-center justify-center space-y-4">
                    <div className="w-16 h-16 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
                    <p className="animate-pulse">ƒêang c·∫≠p nh·∫≠t th·ªùi ti·∫øt...</p>
                  </div>
                ) : (
                  weather && (
                    <>
                      {/* Main Weather Info */}
                      <div className="flex flex-col md:flex-row relative z-10">
                        <div className="w-full md:w-1/2 p-8 md:p-12 flex flex-col items-center md:items-start justify-between min-h-[400px]">
                          <div>
                            <div className="flex items-center gap-2 text-white/80 mb-2">
                              <span>{Icons.mapPin}</span>
                              <span className="text-xl font-medium tracking-wide">{weather.location.name}, {weather.location.country}</span>
                            </div>
                            <div className="text-sm text-white/60">C·∫≠p nh·∫≠t l√∫c: {new Date(weather.location.localtime_epoch * 1000).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}</div>
                          </div>
                          <div className="flex flex-col items-center md:items-start my-8">
                            <div className="drop-shadow-2xl mb-4 text-6xl">{getWeatherIcon()}</div>
                            <h1 className="text-8xl font-bold tracking-tighter drop-shadow-lg">{Math.round(weather.current.temp_c)}¬∞</h1>
                            <p className="text-2xl font-light mt-2 capitalize">{weather.current.condition.text}</p>
                          </div>
                        </div>

                        <div className="w-full md:w-1/2 bg-black/20 p-8 flex flex-col justify-center gap-6">
                          <div className="grid grid-cols-2 gap-4">
                            <StatCard icon={Icons.thermometer} label="C·∫£m gi√°c nh∆∞" value={`${Math.round(weather.current.feelslike_c)}¬∞`} />
                            <StatCard icon={Icons.drop} label="ƒê·ªô ·∫©m" value={`${weather.current.humidity}%`} />
                            <StatCard icon={Icons.wind} label="Gi√≥" value={`${weather.current.wind_kph} km/h`} />
                            <StatCard icon={Icons.alert} label="UV Index" value={`${weather.current.uv}`} />
                          </div>
                          {weather.alerts?.alert?.length > 0 && (
                            <div className="mt-4 bg-red-500/30 border border-red-400/50 rounded-2xl p-4 animate-pulse">
                              <div className="flex items-center gap-2 text-red-100 font-bold mb-1"><span>{Icons.alert}</span> C·∫¢NH B√ÅO</div>
                              <p className="text-sm text-white/90 font-medium">{weather.alerts.alert[0].headline || "Th·ªùi ti·∫øt nguy hi·ªÉm"}</p>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Forecast & Map */}
                      <div className="p-6 space-y-6 relative z-10">
                        {/* Forecast List */}
                         {weather.forecast?.forecastday && (
                            <div className="bg-black/15 border border-white/10 rounded-3xl p-6">
                              <h3 className="text-lg font-semibold text-white mb-4">D·ª± b√°o 7 ng√†y</h3>
                              <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-3">
                                {weather.forecast.forecastday.map((day, idx) => {
                                  const date = new Date(day.date_epoch * 1000);
                                  return (
                                    <button key={idx} onClick={() => setSelectedDayIdx(idx)}
                                      className={`p-3 rounded-2xl flex flex-col items-center gap-1 transition ${selectedDayIdx === idx ? "bg-white/20 shadow-lg scale-105 border border-white/30" : "bg-white/5 hover:bg-white/10"}`}>
                                      <span className="text-xs uppercase opacity-70">{date.toLocaleDateString("vi-VN", { weekday: "short" })}</span>
                                      <span className="text-lg font-bold">{Math.round(day.day.maxtemp_c)}¬∞</span>
                                      <span className="text-xs opacity-60">{Math.round(day.day.mintemp_c)}¬∞</span>
                                      <span className="text-[10px] mt-1 text-blue-200">{day.day.daily_chance_of_rain}% m∆∞a</span>
                                    </button>
                                  );
                                })}
                              </div>
                               {weather.forecast.forecastday[selectedDayIdx] && (
                                 <div className="mt-4 bg-white/10 border border-white/10 rounded-2xl p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-white/80 text-sm">
                                   {(() => {
                                     const day = weather.forecast.forecastday[selectedDayIdx];
                                     return (
                                       <>
                                         <div>
                                           <p className="text-xs text-white/60">Ng√†y</p>
                                           <p className="text-base font-semibold text-white">
                                             {new Date(day.date_epoch * 1000).toLocaleDateString("vi-VN", { weekday: "long", day: "2-digit", month: "2-digit" })}
                                           </p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">ƒêi·ªÅu ki·ªán</p>
                                           <p className="text-base font-semibold text-white">{day.day.condition.text}</p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">Nhi·ªát ƒë·ªô cao / th·∫•p</p>
                                           <p className="text-base font-semibold text-white">{Math.round(day.day.maxtemp_c)}¬∞ / {Math.round(day.day.mintemp_c)}¬∞</p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">Gi√≥ t·ªëi ƒëa</p>
                                           <p className="text-base font-semibold text-white">{day.day.maxwind_kph || day.day.maxwind || 0} km/h</p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">ƒê·ªô ·∫©m trung b√¨nh</p>
                                           <p className="text-base font-semibold text-white">{day.day.avghumidity || day.day.humidity || "N/A"}%</p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">Kh·∫£ nƒÉng m∆∞a</p>
                                           <p className="text-base font-semibold text-white">{day.day.daily_chance_of_rain || 0}%</p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">L∆∞·ª£ng m∆∞a</p>
                                           <p className="text-base font-semibold text-white">{day.day.totalprecip_mm || 0} mm</p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">T·∫ßm nh√¨n TB</p>
                                           <p className="text-base font-semibold text-white">{day.day.avgvis_km || "N/A"} km</p>
                                         </div>
                                         <div>
                                           <p className="text-xs text-white/60">UV</p>
                                           <p className="text-base font-semibold text-white">{day.day.uv || "N/A"}</p>
                                         </div>
                                         <div className="col-span-1 sm:col-span-2">
                                           <p className="text-xs text-white/60">M·∫∑t tr·ªùi m·ªçc / l·∫∑n</p>
                                           <p className="text-base font-semibold text-white">{day.astro?.sunrise || "--"} / {day.astro?.sunset || "--"}</p>
                                         </div>
                                       </>
                                     );
                                   })()}
                                 </div>
                               )}
                            </div>
                         )}

                         {/* Map */}
                        <div className="bg-white/10 border border-white/10 rounded-3xl p-4">
                          <h3 className="text-lg font-semibold text-white mb-2 ml-2">Radar Gi√≥ & M∆∞a</h3>
                          <div className="w-full rounded-2xl overflow-hidden border border-white/10 shadow-lg h-[300px] md:h-[450px]">
                            <iframe title="Windy map" src={mapUrl} className="w-full h-full border-none" loading="lazy"></iframe>
                          </div>
                        </div>
                      </div>
                    </>
                  )
                )}

                {/* Settings Modal */}
                {showSettings && (
                  <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 text-white p-6 rounded-2xl max-w-md w-full shadow-2xl border border-white/10">
                      <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xl font-bold flex items-center gap-2"><span>{Icons.settings}</span> C√†i ƒë·∫∑t</h3>
                        <button onClick={() => setShowSettings(false)} className="hover:text-red-400 transition">{Icons.close}</button>
                      </div>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm text-gray-300 mb-2">WeatherAPI Key (D·ªØ li·ªáu th·ªùi ti·∫øt)</label>
                          <input type="text" value={weatherApiKey} onChange={(e) => setWeatherApiKey(e.target.value)}
                            className="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none text-sm" placeholder="Nh·∫≠p WeatherAPI key..." />
                        </div>
                        <div>
                          <label className="block text-sm text-purple-300 mb-2 font-medium flex items-center gap-1">{Icons.spark} Gemini AI API Key (Cho Chatbot)</label>
                          <input type="password" value={geminiApiKey} onChange={(e) => setGeminiApiKey(e.target.value)}
                            className="w-full bg-slate-900 border border-purple-500/50 rounded-lg px-4 py-2 focus:border-purple-500 focus:outline-none text-sm" placeholder="Nh·∫≠p Gemini API key..." />
                           <p className="text-xs text-gray-400 mt-2">L·∫•y key t·∫°i <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-purple-400 underline">Google AI Studio</a></p>
                        </div>
                        <button onClick={() => { setShowSettings(false); if(weatherApiKey) fetchWeather(query || "Ho Chi Minh"); }}
                          className="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded-lg font-medium transition mt-4">L∆∞u & √Åp d·ª•ng</button>
                      </div>
                    </div>
                  </div>
                )}

                {/* AI Chat Modal */}
                <AIChatModal show={showChat} onClose={() => setShowChat(false)} weatherData={weather} geminiKey={geminiApiKey} />

            </div>
          </div>
        );
      }

      const StatCard = ({ icon, label, value }) => (
        <div className="bg-white/10 p-4 rounded-2xl flex flex-col items-center justify-center text-center hover:bg-white/20 transition duration-300 group">
          <div className="text-white/70 mb-2 group-hover:scale-110 transition text-xl">{icon}</div>
          <span className="text-xs uppercase tracking-wider text-white/50 mb-1">{label}</span>
          <span className="text-lg font-semibold">{value}</span>
        </div>
      );

      ReactDOM.createRoot(document.getElementById("root")).render(<WeatherApp />);
    </script>
  </body>
</html>